<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Download Page</title>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
</head>
<body>
    <h1>Welcome to the Demo Download Page</h1>          
    <p>This page demonstrates how to download files using the Streams API and StreamSaver.js (no memory overflow).</p>
    <a href="#" id="downloadLink">⬇️ Download Large File (Streamed, No RAM Overflow)</a>
    <div id="status"></div>
    <script>
    document.getElementById('downloadLink').addEventListener('click', async function(e) {
        e.preventDefault();
        const status = document.getElementById('status');
        status.textContent = '⏳ Đang tạo file...';
        
        // Thông số file
        const totalSize = 1024 * 1024 * 1024 * 5; // 2GB demo
        const chunkSize = 1024 * 1024 * 50; // 5MB mỗi chunk
        let written = 0;
        let chunkIndex = 0;

        // Tạo stream ghi file bằng StreamSaver
        const fileStream = streamSaver.createWriteStream('large-demo-file.txt');
        const writer = fileStream.getWriter();

        while (written < totalSize) {
            
            const size = Math.floor(Math.min(chunkSize, totalSize - written));
            if (size <= 0) break;
            console.log(`Đang ghi chunk #${chunkIndex} ---- ${totalSize - written}----${size}`);
            const chunk = new Uint8Array(size);
            await writer.write(chunk);
            written += chunk.length;
            chunkIndex++;
            await new Promise(resolve => setTimeout(resolve, 10));
            
        }
        status.textContent = '✅ writer.close() đang được gọi...';
        await writer.close();
        status.textContent = '✅ File đã sẵn sàng để tải (không tràn RAM)!';
    });
    </script>
</body>
</html>