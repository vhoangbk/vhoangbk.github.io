<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeConvert Stats (Admin)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { margin-bottom: 20px; color: #2ecc71; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .card h3 { margin: 0 0 10px; font-size: 0.9rem; color: #666; text-transform: uppercase; }
        .card .value { font-size: 2.5rem; font-weight: bold; color: #333; }
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid #F4D03F; padding-left: 10px; }
        .meta-list { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .meta-item { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 6px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        @media (max-width: 600px) { .meta-list { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="stats-container-v2">
        <header>
            <h1>BeeConvert Admin Stats</h1>
        </header>

        <!-- ROW 1: Metrics Cards -->
        <div class="metrics-grid">
            <!-- Card 1: All Time -->
            <div class="metric-card">
                <h3>Total Clicks (All Time)</h3>
                <div class="metric-value big" id="val-all-time">0</div>
            </div>
            
            <!-- Card 2: 1h -->
            <div class="metric-card">
                <h3>Clicks (1h)</h3>
                <div class="metric-value" id="val-1h-total">0</div>
                <div class="metric-sub">
                    <span class="success">Success: <b id="val-1h-success">0</b></span>
                    <span class="fail">Fail: <b id="val-1h-fail">0</b></span>
                </div>
            </div>

            <!-- Card 3: 24h -->
            <div class="metric-card">
                <h3>Clicks (24h)</h3>
                <div class="metric-value" id="val-24h-total">0</div>
                <div class="metric-sub">
                    <span class="success">Success: <b id="val-24h-success">0</b></span>
                    <span class="fail">Fail: <b id="val-24h-fail">0</b></span>
                </div>
            </div>

            <!-- Card 4: 1 Week -->
            <div class="metric-card">
                <h3>Clicks (1 Week)</h3>
                <div class="metric-value" id="val-7d-total">0</div>
                <div class="metric-sub">
                    <span class="success">Success: <b id="val-7d-success">0</b></span>
                    <span class="fail">Fail: <b id="val-7d-fail">0</b></span>
                </div>
            </div>
        </div>

        <!-- ROW 2: Logs Table -->
        <!-- ROW 2: Logs Table -->
        <div class="logs-section">
            <div class="logs-header">
                <h3>Recent Activity Logs</h3>
                <div class="header-actions">
                    <button class="btn-export" onclick="exportJSON()">Export JSON</button>
                    <button class="btn-search-toggle" onclick="toggleSearch()">üîç Search</button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="search-container" id="searchContainer" style="display:none;">
                <div class="search-row">
                    <select id="searchField" onchange="updateSearchInputs()">
                        <option value="">-- Select Field --</option>
                        <option value="status">Status</option>
                        <option value="filename">Filename</option>
                        <option value="format">Format</option>
                        <option value="size">Size</option>
                        <option value="time">Time</option>
                        <option value="country">Country</option>
                        <option value="ua">User Agent</option>
                    </select>
                    
                    <div id="dynamicInputs" class="dynamic-inputs">
                        <!-- Default Text Input -->
                        <input type="text" id="inputSearchVal" placeholder="Enter keywords...">
                    </div>

                    <button class="btn-go" onclick="performSearch()">Go</button>
                    <button class="btn-clear" onclick="clearSearch()">Clear</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="logs-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Format</th>
                            <th>Status</th>
                            <th>Country</th>
                            <th style="max-width: 200px;">User Agent</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody">
                        <tr><td colspan="7" style="text-align:center">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination-controls">
                <div class="page-size-selector">
                    Rows per page:
                    <select id="pageSizeSelect" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <span id="totalItemsDisplay">Total: 0</span>
                <div class="page-nav">
                    <button id="btnPrev" onclick="changePage(-1)" disabled>Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="btnNext" onclick="changePage(1)" disabled>Next</button>
                </div>
            </div>
        </div>

        <p class="footer-note">Detailed logs are automatically deleted after 24 hours.</p>
    </div>

    <style>
        /* ... existing styles ... */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f6f8; color: #333; margin: 0; padding: 20px; }
        .stats-container-v2 { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header h1 { color: #2ecc71; margin-bottom: 30px; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; text-align: center; }
        .metric-card h3 { margin: 0 0 10px; font-size: 0.9rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; line-height: 1.2; }
        .metric-value.big { font-size: 3.5rem; color: #2ecc71; }
        .metric-sub { font-size: 0.85rem; margin-top: 5px; color: #555; display: flex; justify-content: center; gap: 10px; }
        .metric-sub span { display: block; }
        .metric-sub b { display: inline-block; }
        .success { color: #27ae60; }
        .fail { color: #e74c3c; }

        .logs-section { margin-top: 20px; }
        .logs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .btn-export, .btn-search-toggle { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-search-toggle { background: #9b59b6; }
        .btn-export:hover { background: #2980b9; }

        .search-container { background: #f1f2f6; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #e1e1e1; }
        .search-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .search-row select, .search-row input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .btn-go { background: #2ecc71; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
        .btn-clear { background: #bdc3c7; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        .table-responsive { overflow-x: auto; }
        .logs-table { width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; table-layout: fixed; }
        .logs-table th, .logs-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; word-wrap: break-word; vertical-align: middle; }
        .logs-table th { background: #f8f9fa; font-weight: 600; color: #555; }
        .logs-table tr:hover { background: #f9f9f9; }
        .logs-table td { color: #333; }
        
        /* 1. Time: precise fit for timestamp */
        .logs-table th:nth-child(1), .logs-table td:nth-child(1) { width: 145px; white-space: nowrap; }
        
        /* 2. Filename: Give some flexibility but prioritize UA */
        .logs-table th:nth-child(2), .logs-table td:nth-child(2) { width: 18%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        
        /* 3. Size: "XXX.XX MB -> Y.YY GB" ~ tight fit */
        .logs-table th:nth-child(3), .logs-table td:nth-child(3) { width: 190px; }
        
        /* 4. Format: "h264 -> h265" ~ tight fit */
        .logs-table th:nth-child(4), .logs-table td:nth-child(4) { width: 110px; }
        
        /* 5. Status: Badge only */
        .logs-table th:nth-child(5), .logs-table td:nth-child(5) { width: 80px; text-align: center; }
        
        /* 6. Country: "Vietnam (Local)" */
        .logs-table th:nth-child(6), .logs-table td:nth-child(6) { width: 120px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        
        /* 7. UA: Takes all remaining space */
        .logs-table th:nth-child(7), .logs-table td:nth-child(7) { width: auto; font-family: monospace; font-size: 0.8rem; color: #666; word-break: break-all; }
        
        .output-val { color: #2ecc71; font-weight: 600; } /* Highlight Output */


        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
        .page-size-selector select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        .page-nav { display: flex; align-items: center; gap: 10px; }
        .page-nav button { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .page-nav button:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-nav button:hover:not(:disabled) { background: #f1f1f1; }
        
        .footer-note { margin-top: 30px; color: #999; font-size: 0.8rem; text-align: center; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; color: white; }
        .badge.success { background-color: #2ecc71; }
        .badge.fail { background-color: #e74c3c; cursor: help; }
        .badge.unknown { background-color: #95a5a6; }
    </style>

    <script>
        let allLogs = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentSearchParams = "";

        function toggleSearch() {
            const el = document.getElementById('searchContainer');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function updateSearchInputs() {
            const field = document.getElementById('searchField').value;
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; // clear

            if (field === 'size') {
                container.innerHTML = `
                    <select id="sizeOp"><option value="gt">&gt;</option><option value="lt">&lt;</option></select>
                    <input type="number" id="sizeVal" placeholder="Size" style="width: 80px;">
                    <select id="sizeUnit"><option value="KB">KB</option><option value="MB">MB</option><option value="GB">GB</option></select>
                `;
            } else if (field === 'time') {
                container.innerHTML = `
                    <span style="font-size:0.9rem">From:</span> <input type="time" id="timeStart">
                    <span style="font-size:0.9rem">To:</span> <input type="time" id="timeEnd">
                `;
            } else if (field === 'status') {
                container.innerHTML = `
                    <select id="statusVal" style="width: 150px;">
                        <option value="true">Success</option>
                        <option value="false">Fail</option>
                    </select>
                `;
            } else {
                container.innerHTML = `<input type="text" id="inputSearchVal" placeholder="Search text...">`;
            }
        }

        function performSearch() {
            const field = document.getElementById('searchField').value;
            if (!field) return;

            const params = new URLSearchParams();
            params.append('field', field);

            if (field === 'size') {
                const op = document.getElementById('sizeOp').value;
                const val = parseFloat(document.getElementById('sizeVal').value);
                const unit = document.getElementById('sizeUnit').value;
                if (isNaN(val)) return;

                let bytes = val;
                if (unit === 'KB') bytes *= 1024;
                if (unit === 'MB') bytes *= 1024 * 1024;
                if (unit === 'GB') bytes *= 1024 * 1024 * 1024;

                if (op === 'gt') params.append('min', bytes);
                else params.append('max', bytes);
                
            } else if (field === 'time') {
                const start = document.getElementById('timeStart').value;
                const end = document.getElementById('timeEnd').value;
                
                // Construct Date from Time (Today)
                const today = new Date();
                const getTs = (timeStr) => {
                    const [h, m] = timeStr.split(':');
                    const d = new Date(today);
                    d.setHours(h, m, 0, 0);
                    return d.getTime();
                };

                if (start) params.append('min', getTs(start));
                if (end) params.append('max', getTs(end));

            } else if (field === 'status') {
                const val = document.getElementById('statusVal').value;
                params.append('val', val);
            } else {
                const val = document.getElementById('inputSearchVal').value;
                params.append('val', val);
            }

            currentSearchParams = params.toString();
            console.log("Searching:", currentSearchParams);
            loadStats();
        }

        function clearSearch() {
            document.getElementById('searchField').value = "";
            updateSearchInputs();
            currentSearchParams = "";
            loadStats();
        }

        async function loadStats() {
            try {
                let url = '/api/stats';
                if (currentSearchParams) {
                    url += '?' + currentSearchParams;
                }
                const res = await fetch(url);
                const data = await res.json();
                
                // 1. Render Metrics (Always from raw data response? No, usually separate endpoint or global. 
                //    But here we return metrics in same call. Search applies to logs only or metrics too?
                //    Our backend logic applies filter ONLY to logs list, NOT metrics. Correct.)
                document.getElementById('val-all-time').textContent = (data.allTime?.totalClicks || 0).toLocaleString();
                
                const renderMetric = (prefix, obj) => {
                    const total = obj.total || 0;
                    document.getElementById(prefix + '-total').textContent = total.toLocaleString();
                    document.getElementById(prefix + '-success').textContent = obj.success || 0;
                    document.getElementById(prefix + '-fail').textContent = obj.fail || 0;
                };

                const metrics = data.metrics || { p1h: {}, p24h: {}, p7d: {} };
                renderMetric('val-1h', metrics.p1h);
                renderMetric('val-24h', metrics.p24h);
                renderMetric('val-7d', metrics.p7d);

                // 2. Handle Logs
                allLogs = data.logs || [];
                document.getElementById('totalItemsDisplay').textContent = `Total: ${allLogs.length} items`;
                
                currentPage = 1; // Reset page on new search
                renderLogs();

            } catch (err) {
                console.error("Stats error", err);
            }
        }

        function renderLogs() {
            const tbody = document.getElementById('logsBody');
            tbody.innerHTML = '';

            if (allLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #888;">No logs found matching criteria.</td></tr>';
                document.getElementById('pageInfo').textContent = 'Page 0';
                return;
            }

            const totalPages = Math.ceil(allLogs.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = allLogs.slice(start, end);

            pageItems.forEach(log => {
                const tr = document.createElement('tr');
                const date = new Date(log.timestamp).toLocaleTimeString() + ' ' + new Date(log.timestamp).toLocaleDateString();
                const filename = log.video?.filename || 'Unknown';
                
                // Helper to highlight output part
                const highlightOutput = (str) => {
                    if (!str || typeof str !== 'string') return str || '-';
                    if (str.includes('->')) {
                        const parts = str.split('->');
                        // Use arrow entity and color the second part
                        return `${parts[0]} <span style="color:#aaa">&rarr;</span> <span class="output-val">${parts[1]}</span>`;
                    }
                    return str;
                };

                // Size Logic: Input -> Output (Pre-formatted by client)
                const sizeDisplay = highlightOutput(log.video?.size);
                
                const format = highlightOutput(log.convert?.format);
                
                // --- STATUS LOGIC ---
                let statusHtml = '';
                if (log.convert?.success) {
                    statusHtml = '<span class="badge success">Success</span>';
                } else {
                    const error = log.convert?.errorCode || 'Unknown Error';
                    // Escape basic HTML chars for tooltip
                    const safeError = error.replace(/"/g, '&quot;');
                    statusHtml = `<span class="badge fail" title="${safeError}">Fail</span>`;
                    // Add visible error message below badge
                    statusHtml += `<div style="font-size:0.75rem; color:#e74c3c; margin-top:4px; max-width: 150px; line-height: 1.2;">${safeError}</div>`;
                }
                
                const country = log.user?.country || 'Unknown';
                // User Agent: Show detailed info
                let uaDisplay = "Unknown";
                if (log.user) {
                   // Prefer server-side parsed data if available
                   if (log.user.browser && log.user.os) {
                       const b = log.user.browser;
                       const os = log.user.os;
                       uaDisplay = `<b>${b.name || ''}</b> ${b.version || ''}<br>`;
                       uaDisplay += `<small>${os.name || ''} ${os.version || ''}</small>`;
                       
                       // Add device model if available (mostly mobile)
                       if (log.user.device && (log.user.device.vendor || log.user.device.model)) {
                           uaDisplay += `<br><small style="color:#e67e22">${log.user.device.vendor || ''} ${log.user.device.model || ''}</small>`;
                       }
                   } else {
                       // Fallback to old simple string
                       uaDisplay = `${log.user.browser} / ${log.user.os}`; 
                   }
                }
                
                tr.innerHTML = `
                    <td>${date}</td>
                    <td title="${filename}">${filename}</td>
                    <td>${sizeDisplay}</td>
                    <td>${format}</td>
                    <td>${statusHtml}</td>
                    <td>${country}</td>
                    <td>${uaDisplay}</td>
                `;
                tbody.appendChild(tr);
            });

            // Pagination UI
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;
        }
        
        // ... rest of functions (changePage, changePageSize, exportJSON) ...
        
        function changePage(delta) {
            currentPage += delta;
            renderLogs();
        }

        function changePageSize() {
            const select = document.getElementById('pageSizeSelect');
            itemsPerPage = parseInt(select.value);
            currentPage = 1;
            renderLogs();
        }

        function exportJSON() {
            if (!allLogs || allLogs.length === 0) {
                alert("No logs to export!");
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allLogs, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "beeconvert_logs_" + new Date().toISOString() + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        loadStats();
        setInterval(() => {
            // Only auto-refresh if no search is active to avoid disrupting user
            if (!currentSearchParams) loadStats();
        }, 30000); 
    </script>
</body>
</html>
