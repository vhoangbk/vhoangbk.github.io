<html>
  <head>
    <title>Test Upload Stream</title>
  </head>
  <body>
    <h1>Test Upload Stream</h1>
    <div>
      <video
        id="idVideo"
        width="320"
        height="240"
        controls
        autoplay
        loop
        crossorigin="anonymous"
        src="http://192.168.1.21:8282/video-data?id=B2498147-E6FD-42E7-B0CB-E14CEC7FAB98/L0/001"
      >
    </div>
    <div>
      <input id="idInputFile" type="file" accept="video/*" />
    </div>
    <div>
      <button onclick="onClickUpload()">Upload</button>
      <button onclick="onClickUploadStream()">Upload Stream</button>
    </div>
    <div id="status"></div>
  </body>

  <script>
    const BASE_URL = "http://192.168.1.21:8282"
    async function callApiUploadStream(data, fileName) {
      let statusDiv = document.getElementById("status");
      try {
        // Tạo binary data mẫu
        const formData = new FormData();
        formData.append("filename", fileName);
        formData.append("action", data.byteLength > 0 ? "write" : "complete");
        formData.append("data", new Blob([data]), "file.bin");

        console.log(
          "callApiUploadStream action:",
          data.length > 0 ? "write" : "complete"
        );

        const response = await fetch(`${BASE_URL}/upload-stream`, {
          method: "POST",
          body: formData,
        });
        const json = await response.json();
        console.log("response --> ", json);
        statusDiv.innerText += JSON.stringify(json) + "\n";
        return json;
      } catch (error) {
        console.log("error:", error);
        return null;
      }
    }

    async function uploadFileInChunks(
      fileName,
      totalSize,
      chunkSize,
      fileData
    ) {
      let statusDiv = document.getElementById("status");
      statusDiv.innerText = '';
      let uploadedSize = 0;

      while (uploadedSize < totalSize) {
        const remainingSize = totalSize - uploadedSize;
        const currentChunkSize = Math.min(chunkSize, remainingSize);
        const dataChunk = fileData.slice(
          uploadedSize,
          uploadedSize + currentChunkSize
        );
        let res = await callApiUploadStream(dataChunk, fileName);
        if (!res || res.status != 200) {
          console.log("Upload chunk failed, stopping upload.");
          statusDiv.innerText += "Upload chunk failed, stopping upload.\n";
          return;
        }
        uploadedSize += currentChunkSize;
        console.log(
          `Uploaded ${uploadedSize} of ${totalSize} bytes --> ${
            (uploadedSize / totalSize) * 100
          }% `
        );
        let progress = `Uploaded ${uploadedSize} of ${totalSize} bytes --> ${
          ((uploadedSize / totalSize) * 100).toFixed(2)
        }% \n`;
        statusDiv.innerText += progress;
      }

      // Gửi yêu cầu hoàn tất
      await callApiUploadStream(new Uint8Array(0), fileName);
    }

    function onClickUploadStream() {
      let input = document.getElementById("idInputFile");
      let file = input.files[0];
      if (!file) {
        console.log("No file selected, using default parameters for upload.");
      }
      console.log("file:", file);

      let name = file.name;
      let totalSize = file.size;
      let chunkSize = 1 * 1024 * 1024; // 1 MB

      let blob = URL.createObjectURL(file);
      const reader = new FileReader();
      reader.onload = () => {
        const data = reader.result;
        uploadFileInChunks(name, totalSize, chunkSize, data);
      };
      reader.readAsArrayBuffer(file);
    }

    async function onClickUpload() {
      let statusDiv = document.getElementById("status");
      let input = document.getElementById("idInputFile");
      let file = input.files[0];
      if (!file) {
        console.log("No file selected.");
        return;
      }

      let fileName = file.name;

      try {
        const formData = new FormData();
        formData.append("video", file, fileName);

        const response = await fetch(`${BASE_URL}/upload`, {
          method: "POST",
          body: formData,
        });
        const json = await response.json();
        console.log("response --> ", json);
        statusDiv.innerText = JSON.stringify(json);
        return json;
      } catch (error) {
        console.log("error:", error);
      }
    }
  </script>
</html>

/save-data/filename
/save-file/filename
/get-file/filename
/delete-file/filename